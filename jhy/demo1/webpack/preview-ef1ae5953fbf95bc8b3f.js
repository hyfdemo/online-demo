(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{11:function(e,t,r){r("201c"),e.exports=r("Z3xQ")},KUpD:function(e,t){e.exports={"install-page-wrapper":"_2145f6w_gvAx5jbCLSvNm1","install-page":"_1ucR52TRm2uhcZJhUjsxqG"}},Z3xQ:function(e,t,r){"use strict";r.r(t);var n=r("zkrS"),a=r("7eYF"),o=r("aqSL"),s=r("lw2U"),i=r("+Cau"),c=r("rbsZ"),l=r("abHt"),p=r("q1tI"),u=r.n(p),d=r("i8i4"),m=r.n(d),w=r("XkTy"),f=r("17x9"),h=r("ldhK"),v=r.n(h);function g(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}var b="/images/sharing/wechat_"+window.MBLocale+".png",k="/images/sharing/ios_"+window.MBLocale+".png",y=function(e){function t(){var r,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);for(var a=arguments.length,o=Array(a),s=0;s<a;s++)o[s]=arguments[s];return r=n=g(this,e.call.apply(e,[this].concat(o))),n.handleClick=function(){n.props.onClose()},g(n,r)}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.render=function(){var e=this.props.show,t=MB.isWechat(),r=!t&&MB.isIOS(),n=MB.isiPad(),a=!(t||r),o={display:e?"":"none"};return u.a.createElement("div",{className:v.a.covers,style:o,onClick:this.handleClick},t&&u.a.createElement("div",{className:"cover wechat"},u.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),u.a.createElement("img",{className:"tips",src:b}),"s",u.a.createElement("div",{className:"arrow"})),r&&!n&&u.a.createElement("div",{className:"cover ios"},u.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),u.a.createElement("img",{className:"tips",src:k}),u.a.createElement("div",{className:"arrow"})),n&&u.a.createElement("div",{className:"cover ipad"},u.a.createElement("img",{className:"robot",src:"/images/sharing/robot.png"}),u.a.createElement("img",{className:"tips",src:k}),u.a.createElement("div",{className:"arrow"})),a&&u.a.createElement("div",{className:"cover building"},u.a.createElement("div",{className:"tip-wrapper"},u.a.createElement("p",{className:"tip"},I18N.building_apk),u.a.createElement("div",{className:"spinner"}))))},t}(p.PureComponent),E=y;y.propTypes={show:f.PropTypes.bool,onClose:f.PropTypes.func};var P=r("KUpD"),N=r.n(P),x=r("UbMB"),j=r.n(x),M=r("t3Un");var _,S,C=j.a.bind(N.a),B=(_=regeneratorRuntime.mark(function e(t){var r,n,a;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return MB.event("移动端: 点击下载 APK","运行页"),e.next=3,Object(M.b)("/app/"+t+"/build/apk.json",null,{method:"PUT"});case 3:return e.next=6,I(5e3);case 6:return e.next=8,Object(M.b)("/app/"+t+"/status/apk.json");case 8:if(r=e.sent,n=r.progress,a=r.link,100===n){e.next=13;break}return e.abrupt("continue",3);case 13:return window.location=a,e.abrupt("return");case 17:case"end":return e.stop()}},e,void 0)}),S=function(){var e=_.apply(this,arguments);return new Promise(function(t,r){return function n(a,o){try{var s=e[a](o),i=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});t(i)}("next")})},function(e){return S.apply(this,arguments)}),I=function(e){return new Promise(function(t){return setTimeout(t,e)})},T=function(e,t){MB.event("移动端: 点击下载安卓客户端","运行页");var r=window.location,n=r.hostname,a=r.pathname,o=navigator.userAgent.toLowerCase(),s=document.createElement("iframe");if(document.body.appendChild(s),s.style.cssText="display:none;width=0;height=0",setTimeout(function(){window.location=e},200),console.log("userAgent",o),o.includes("chrome")&&o.includes("android")&&!o.includes("ucbrowser")&&!o.includes("quark")){var i="intent://"+n+a+"?password="+t+"#Intent;package=com.mockingbot;scheme=mockingbot;S.browser_fallback_url="+e+";end";s.src=i}else{var c="mockingbot://"+n+a+"?password="+t;window.open(c)}},O=function(e,t){MB.event("移动端: 点击下载 iOS 客户端","运行页");var r=window.location,n="modao://"+r.hostname+r.pathname+"?password="+t;setTimeout(function(){window.location=e},25),window.location=n},R=function(e){function t(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var r=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}(this,e.call(this));return r.handleView=function(e){e.preventDefault(),r.props.loadProject()},r.handleInstall=function(e){e.preventDefault();var t=r.props.project,n=t.accessToken,a=t.userPlan,o=t.exportable;MB.isWechat()?r.setState({isCoverShow:!0}):MB.isiPad()||MB.isIOS()?r.setState({isCoverShow:!0}):o?(r.setState({isCoverShow:!0}),B(n).then(function(){return r.setState({isCoverShow:!1})}).catch(function(e){})):MB.promptRenew("exportable",{format:"apk",role:"project",plan:a})},r.handleDownload=function(e){var t=r.props.encryptedPassword;MB.isWechat()?r.setState({isCoverShow:!0}):MB.isIOS()?O(e,t):MB.isAndroid()&&T(e,t)},r.handleCloseCover=function(){r.setState({isCoverShow:!1})},r.state={isCoverShow:!1},r}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(t,e),t.prototype.componentDidMount=function(){$("#splash").hide(),$("#workspace").show(),$.timeago.settings.lang=window.MBLocale,$(".timeago").timeago()},t.prototype.render=function(){var e=this,t=this.props.project,r=t.name,n=t.iconUrl,a=t.updatedAt,o=t.ios_client_url,s=t.android_client_url,i=this.state.isCoverShow,c=MB.isAndroid(),l=c?s:o,p=c?I18N.download_android_apk:I18N.add_to_home_screen;return u.a.createElement("div",{className:C("install-page-wrapper")},u.a.createElement("div",{className:C("install-page",{"is-wechat":MB.isWechat()})},u.a.createElement("div",{className:"app-inner"},u.a.createElement("img",{className:"app-icon",src:n}),u.a.createElement("h1",{className:"app-name"},r),u.a.createElement("div",{className:"app-update-time"},u.a.createElement("time",{className:"timeago",dateTime:a}),I18N.update),u.a.createElement("div",{className:"install-btns"},u.a.createElement("a",{className:"install-btn primary",onClick:function(){return e.handleDownload(l)}},I18N.open_in_client),u.a.createElement("a",{className:"install-btn",onClick:this.handleView},I18N.view_app)),u.a.createElement("a",{className:"download-btn",onClick:this.handleInstall},u.a.createElement("span",null,p),u.a.createElement("i",{className:"fa fa-angle-right"}))),u.a.createElement(E,{show:i,onClose:this.handleCloseCover})))},t}(p.PureComponent);R.propTypes={project:f.PropTypes.object,loadProject:f.PropTypes.func,encryptedPassword:f.PropTypes.string};var D=R;function A(e){return function(){var t=e.apply(this,arguments);return new Promise(function(e,r){return function n(a,o){try{var s=t[a](o),i=s.value}catch(e){return void r(e)}if(!s.done)return Promise.resolve(i).then(function(e){n("next",e)},function(e){n("throw",e)});e(i)}("next")})}}var q=window,L=q.$,U=q.MB,W=q.MBLocale,K=q.md5,G=q.Pusher,F=q.AutoSaver,J=q.SharingRunner,Z=U.localStorageDelegate,Q=function(){return!!window.MBData},H=/\/embed\b/.test(location.pathname);U.f.inSharing=!0,U.load=function(){var e=A(regeneratorRuntime.mark(function e(t){var r,n,a,o,s=t.token,i=t.isPasswordRequired,c=t.encryptedPassword,l=t.installerProject;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(U.webpackInterface.renderPreviewAlert(),r=c||new URLSearchParams(location.search).get("password")||Z.getItem(s+"_pwd"),n=!U.isStandAlone()&&!U.isInApp&&U.isMobile()&&!Q()&&!H,U.supportedBrowser()){e.next=7;break}return L("#splash").hide(),L("#loading").hide(),e.abrupt("return");case 7:if(a=U.isMac()?"mac":U.isWindows()?"windows":"other-os",L("html").addClass(a),!n){e.next=15;break}return e.next=12,X({token:s,isPasswordRequired:i,savedEncryptedPassword:r,shouldGetData:!1});case 12:return L("#loading").hide(),e.next=15,new Promise(function(e){m.a.render(u.a.createElement(D,{project:l,loadProject:e,encryptedPassword:r}),document.getElementById("workspace"))});case 15:return e.next=17,X({token:s,isPasswordRequired:i,savedEncryptedPassword:r});case 17:return o=e.sent,e.abrupt("return",Q()?re(o):o?te(o):null);case 19:case"end":return e.stop()}},e,void 0)}));return function(t){return e.apply(this,arguments)}}();var V,Y,z=(V=A(regeneratorRuntime.mark(function e(t){var r,n,a,o=t.token,s=t.encryptedPassword,i=t.shouldGetData,c=void 0===i||i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(r=window.MBData,!Q()){e.next=5;break}if(!r.project.password||s===r.project.password){e.next=4;break}throw new Error("Wrong password!");case 4:return e.abrupt("return",r);case 5:if(c){e.next=13;break}return e.next=8,fetch("/app/"+o+"/checkpassword?password="+s);case 8:if(n=e.sent,n.ok){e.next=12;break}throw new Error("Wrong password!");case 12:return e.abrupt("return",!0);case 13:return a="/app/"+o+".json?"+(new Date).valueOf()+(s?"&password="+s:""),e.abrupt("return",ee(a));case 15:case"end":return e.stop()}},e,void 0)})),function(e){return V.apply(this,arguments)}),X=(Y=A(regeneratorRuntime.mark(function e(t){var r,n,a=t.token,o=t.isPasswordRequired,s=t.savedEncryptedPassword,i=t.shouldGetData,c=void 0===i||i;return regeneratorRuntime.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return r=void 0,e.prev=1,e.next=4,z({token:a,shouldGetData:c,encryptedPassword:s});case 4:r=e.sent,e.next=11;break;case 7:e.prev=7,e.t0=e.catch(1),console.log("Invalid saved password: "+e.t0+". Will retry with prompt."),Z.removeItem(a+"_pwd");case 11:if(r){e.next=33;break}if(e.prev=12,!o){e.next=25;break}return e.t1=K,e.next=17,Object(w.c)({desc:I18N.credential_required});case 17:return e.t2=e.sent,n=(0,e.t1)(e.t2),e.next=21,z({token:a,shouldGetData:c,encryptedPassword:n});case 21:r=e.sent,Z.setItem(a+"_pwd",n),e.next=26;break;case 25:Object(w.a)({desc:I18N.no_permission_to_app});case 26:e.next=33;break;case 28:return e.prev=28,e.t3=e.catch(12),console.log("Invalid prompt password:",e.t3),setTimeout(function(){return Object(w.a)({desc:o?I18N.invalid_credential:"Failed to load this app."})},320),e.abrupt("return",null);case 33:return e.abrupt("return",r);case 34:case"end":return e.stop()}},e,void 0,[[1,7],[12,28]])})),function(e){return Y.apply(this,arguments)}),ee=function(e){return new Promise(function(t,r){return L.getJSON(e,function(e){return t(e)}).fail(function(e,t,n){return r(n)})})},te=function(e){L(".indicator").css("height","100%"),setTimeout(function(){return ne(e)},300)},re=function(e){U.staticMap=function(){return"images/workspace/staticmap_"+W+".png"},e.project.splash="images/splash.png",e.screens.forEach(function(e){e.bgimage&&(e.bgimage=e.bgimage.replace(/^.+uploads.*?\//,""))}),e.widgets.forEach(function(e){e.image&&(e.image=e.image.replace(/^.+uploads.*?\//,""))}),e.widgetstates.forEach(function(e){e.image&&(e.image=e.image.replace(/^.+uploads.*?\//,""))}),L(".indicator").css("height","100%"),setTimeout(function(){return ne(e)},300)},ne=function(e){var t=e.project.template?new Template:e.project.combo?new Combo:new Project;t.load(e.project),t.lsave(!1),Template.refresh(e.templates),Screen.refresh(e.screens),Widget.refresh(e.widgets),Link.refresh(e.links),Panel.refresh(e.panels),Screenstate.refresh(e.screenstates),Widgetstate.refresh(e.widgetstates),Panelstate.refresh(e.panelstates),Collaborator.refresh(e.collaborators),CommentThread.refresh(e.threads),Comment.refresh(e.comments),Team.refresh(e.teams),U.user=L("#workspace").data("user")||{},U.user.id&&(U.pusher=new G,U.pusher.subscribe(t.cid)),U.isMobile()||(U.autoSaver=new F),(new Image).src=U.staticMap(),L("title").html(t.name),L("#loading").hide(),!t.validated&&U.isMobile()&&Object(w.a)({title:I18N.reminder,desc:I18N.fraud_warning,confirmText:I18N.fraud_confirm,isHTML:!0}),U.checkFA(function(){L(".box").hide(),U.currentProject=t,U.webpackInterface.init(),U.runner=new J(t),U.runner.render()})};r("KKmY"),r("P3rE"),r("dppN");MB.COMPONENTS=l.b;try{n.a.MB.webpackInterface=Object(a.a)(o.a),n.a.MB.setRunnerExtra=s.a,n.a.MB.renewMsg=c.a,n.a.MB.promptRenew=c.c,n.a.MB.messageBucket=Object(i.a)(i.b)}catch(e){console.warn("[UI:Preview] Failed to init:",e.stack||e)}},ldhK:function(e,t){e.exports={covers:"_2fva7dqNrMTA3qQj2Sag2u"}}},[[11,0,1,2]]]);
//# sourceMappingURL=preview-ef1ae5953fbf95bc8b3f.js.map